<html>
  <head>
    <style type="text/css">
		html,
		body {
			width:300px;
			height: 300px;
		}
		body {
			margin:0;
			padding:5px;
		}
		
		/* The div for the title */
		div#Title {
			font: normal 14px Verdana;
			
			
		}

		/* Title link */
		a:link#link {
			text-decoration: none;
			border-bottom: 1px dotted #ff5353;
			/* font: normal 9px Verdana; */
		}
		
		a:hover#link {
			text-decoration: underline;
			border-bottom: 1px dashed #ff5353;
			/* font: normal 9px Verdana; */
		}
		
		a:visited#link {
			text-decoration: none;
			color: red;
			border-bottom: 1px dashed #ff5353;
			/* font: normal 9px Verdana; */
		}
		
		/* The div for the comment */
		div#holder {
			width: 90%;
			height:100%;
			min-height:100%;
			background-color:white;
			font-family: Arial;
			font-size: 14px;
		}
    </style>
	
	<!-- Javascript -->
    <script>
	// webdb stuff
	var database = {};
  	database.webdb = {};
	database.webdb.db = null;
	
	// open the db
	database.webdb.open = function() {
  		var dbSize = 5 * 1024 * 1024; // 5MB
  		console.log("Size is " + dbSize);
  		try {
  			database.webdb.db = openDatabase('Comments', '1.0', 'saves comments', dbSize);
			console.log(database.webdb.db);
  		} catch (e) {
    		console.log(e);
  		}
	}	

	// handling error
	database.webdb.onError = function(tx, e) {
  		console.log('Something unexpected happened: ' + e.message );
	}

	// on success
	database.webdb.onSuccess = function(tx, r) {
  		console.log('DB opened successfully');
	}

	// gets a comment
	database.webdb.getComment = function(renderFunc, id) {
	  //console.log('Id in getcomment = ' + id);
	  database.webdb.db.transaction(function(tx) {
		console.log('Id passed in: ' + id);
		tx.executeSql('SELECT * FROM comment WHERE ID=?', [id.toString()], renderFunc, 
				database.webdb.onError);
	  });
	}

	// stores the last comment
	var lastComment;		
	var lastURL;
	var lastTitle;

	// callback function for checking if a comment exists in the table
	function getCommentCB(tx, rs) {
		console.log('\nRS Length = ' + rs.rows.length);
		
		for (var i=0; i < rs.rows.length; i++) {
			console.log('RS ' + i + ' = ' + rs.rows.item(i));
		}
		if (rs.rows.length == 0) {// none found
			lastComment = "No comments saved!";
			lastURL = "";
			lastTitle = "";
		}
		else {
			lastComment = rs.rows.item(0).comment;
			lastURL = rs.rows.item(0).url;
			lastTitle = rs.rows.item(0).title;
		}
			
		// hack:
		// if comment is only size 
		console.log('lastComment: ' + lastComment);
		console.log('lastTitle: ' + lastTitle);
		console.log('lastURL: ' + lastURL);
	}

	// Variables for getting the key from localstorage	
	var logging = false;
	var key = "id";
	var val1;	
	
	// start
	function start() {
		populate();
	}
	
	// populates the popup
    function populate() {
		// open database
		try {
			database.webdb.open();
			//console.log('database open');
		
			// get the key from local storage
        	val1 = getValue(key);
			
			// convert it to an int and get the previous one
			val1 = parseInt(val1) - 1;
			//console.log('Val1 = ' + val1);
        	
			// update the comment in the popup
			updateValues(val1);
        	//log('leaving populate()');
		} catch (e) {
	        console.log("error while doing something");
	        console.log(e);
	      }
      }
      
	// returns the item from local storage given the key	  
	function getValue(key) {
		return chrome.extension.getBackgroundPage().getItem(key);
	}

	// Shows the comment
	function updateValues(value) {
		//console.log('Inside update values');
	    
		// look up the database and get the comment
		database.webdb.getComment(getCommentCB, value);
		//setTimeout("console.log('After get comment')", 000);
	  
	  	// set a little delay to ensure that the comment shows up
		setTimeout("document.getElementById('link').href = lastURL", 100);
		setTimeout("document.getElementById('Title').innerText = lastTitle", 100);
		setTimeout("document.getElementById('lastcomment').innerText = lastComment", 100);
	}

    </script>
  </head>
  <body onload='start()'>
    <div id='holder'>
		<a href="" id='link'>				<!-- The Link -->
			<div id='Title'></div> 			<!-- The Title -->
		</a>
		<br>
		<div id='lastcomment'></div>		<!--Last value will show up here-->
	</div>
	<!-- <form name='form1'>
      <table class="my_table" cellpadding="0" cellspacing="0" width=200px>
        <tr>
	  	  <td class="style1" colspan="2" align="center">Local Storage Sample</td>
	  	</tr>
	  	<tr class="odd">
		  <td class="rborder" >Please Enter the name</td>
		  <td class="ralign"><input type='text' size='6' name='fname'/></td>
		</tr>
		<tr class="even">
		  <td class="rborder" colspan="2" align='center'>
		    <input type='submit' value='store' OnClick='store()'/>
		    <input type='submit' value='clear' OnClick='clearStorage()'/></td>
	    </tr>
		<tr class="odd"
		  <td class="rborder"></td>
		  <td class="ralign"></td>
		</tr>
		<tr class="even">
		<td colspan="2"><a  href='javascript:void(0);' onclick='chrome.tabs.create({url: "comments.html"});'>Previous Values Stored</a></td>
		</tr>
		<tr class="odd"
		  <td class="rborder">Last Value stored 1</td>
		  <td class="ralign"><div id='val1'/></td>
		</tr>
		<tr class="even"
		  <td class="rborder">Last Value stored 2</td>
		  <td class="ralign"><div id='val2'/></td>
		</tr>
		<tr class="odd"
	      <td class="rborder">Last Value stored 3</td>
		  <td class="ralign"><div id='val3'/></td>
		</tr>
      </table>
    </form>-->
  </body>
</html>
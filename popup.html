<html>
  <head>
  	<link rel="stylesheet" href="Style.css" />
	
	<!-- Javascript -->
    <script>
	// webdb stuff
	var database = {};
  	database.webdb = {};
	database.webdb.db = null;
	
	// open the db
	database.webdb.open = function() {
  		var dbSize = 5 * 1024 * 1024; // 5MB
  		console.log("Size is " + dbSize);
  		try {
  			database.webdb.db = openDatabase('Comments', '1.0', 'saves comments', dbSize);
			console.log(database.webdb.db);
  		} catch (e) {
    		console.log(e);
  		}
	}	

	// handling error
	database.webdb.onError = function(tx, e) {
  		console.log('Something unexpected happened: ' + e.message );
	}

	// on success
	database.webdb.onSuccess = function(tx, r) {
  		console.log('DB opened successfully');
	}

	// gets a comment
	database.webdb.getComment = function(renderFunc, id) {
	  //console.log('Id in getcomment = ' + id);
	  database.webdb.db.transaction(function(tx) {
		console.log('Id passed in: ' + id);
		tx.executeSql('SELECT * FROM comment WHERE ID=?', [id.toString()], renderFunc, 
				database.webdb.onError);
	  });
	}

	// stores the last comment
	var lastComment;		
	var lastURL;
	var lastTitle;

	// callback function for checking if a comment exists in the table
	function getCommentCB(tx, rs) {
		console.log('\nRS Length = ' + rs.rows.length);
		
		for (var i=0; i < rs.rows.length; i++) {
			console.log('RS ' + i + ' = ' + rs.rows.item(i));
		}
		if (rs.rows.length == 0) {// none found
			lastComment = "No comments saved!";
			lastURL = "";
			lastTitle = "";
		}
		else {
			lastComment = rs.rows.item(0).comment;
			lastURL = rs.rows.item(0).url;
			lastTitle = rs.rows.item(0).title;
		}
			
		// hack:
		// if comment is only size 
		console.log('lastComment: ' + lastComment);
		console.log('lastTitle: ' + lastTitle);
		console.log('lastURL: ' + lastURL);
	}

	// Variables for getting the key from localstorage	
	var logging = false;
	var key = "id";
	var val1;	
	
	// start
	function start() {
		populate(1);
	}
	
	// populates the popup
    function populate(diff) {
		// open database
		try {
			database.webdb.open();
			//console.log('database open');
		
			// get the key from local storage
        	val1 = getValue(key);
			
			// convert it to an int and get the previous one
			val1 = parseInt(val1) - diff;
			//console.log('Val1 = ' + val1);
        	
			// update the comment in the popup
			updateValues(val1);
        	//log('leaving populate()');
		} catch (e) {
	        console.log("error while doing something");
	        console.log(e);
	      }
      }
      
	// returns the item from local storage given the key	  
	function getValue(key) {
		return chrome.extension.getBackgroundPage().getItem(key);
	}

	// Opens the page clicked in the link
	function openPage(URL) {
		console.log("Inside open page");
		chrome.tabs.create({url: URL});
	}
	
	// Shows the comment
	function updateValues(value) {
		//console.log('Inside update values');
	    
		// look up the database and get the comment
		database.webdb.getComment(getCommentCB, value);
		//setTimeout("console.log('After get comment')", 000);
	  
		// make sure proper comment shows up
		if (lastComment == "No comments saved!" && key > 0) { // Something should be shown!
			populate(2);
		}
	  
	  	// set a little delay to ensure that the comment shows up
		setTimeout("document.getElementById('link').href = \"javascript:window.open(lastURL)\"", 100);
		setTimeout("document.getElementById('Title2').innerText = lastTitle", 100);
		setTimeout("document.getElementById('lastcomment2').innerText = lastComment", 100);
	}

    </script>
  </head>
  <body onload='start()'>
    <div id='holder'>
		<a href='javascript:window.open("allcomments.html");' id='alllink'>
		<div id='allcomments'>				<!-- Link to all the comments -->
			View all comments
		</div></a>
		<br>
		<div id='Title'>
			Page:<br>
			<a href="" id='link'>
				<div id='Title2'>			<!-- The Title -->
				</div>
			</a>
		</div>
		<div id='middlepadding'></div>		
		<div id='lastcomment'>
			Comment:<br>
			<div id='lastcomment2'>
			</div>
		</div>								<!--Last value will show up here-->
		<div id='somepadding'></div>
	</div>
	
  </body>
</html>
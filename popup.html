<html>
  <head>
    <style>
		html,
	body {
	width:300px;
	height: 200px;
	}
	body {
	margin:0;
	padding:5px;
	}
	div#lastcomment {
	height:100%;
	min-height:100%;
	background-color:pink;
	}
	
	
	  	.my_table {
	  	   margin:2px;
	  	   font-family:Arial;
	  	   font-size:11px;
	  	   border: solid 1px #aaaaaa;
		}

		.my_table tr.odd {
		  background-color:#fff5cc;
		}

		.my_table tr.even {
		  background-color:#ffffff;
		}

		.my_table td {
		  padding: 3px;
		  vertical-align:top;
		}

		.my_table td.rborder {
		  border-right: solid 1px #aaaaaa;
		}

		.my_table td.bborder {
		  border-bottom: solid 1px #aaaaaa;
		}

		.my_table td.tborder {
		  border-top: solid 1px #aaaaaa;
		}

		.my_table td.ralign {
		  text-align: right;
		}

		.my_table td.calign {
		  text-align: center;
		}

		.my_table tr.heading td {
		  padding: 5px;
		  font-weight: bold;
		  text-align: center;
		  background-color: #aff2fb;
		}

		.my_table td.odd {
		  background-color: #aff2fb;
		}

		.my_table td.even {
		  background-color: #ffffff;
		}

		.style1 {
			font-size: 12px;
			font-weight: bold;
			color: #000000;
			line-height: 1.5;
	   }
    </style>
    <script>
	// webdb stuff
	var database = {};
  	database.webdb = {};
	database.webdb.db = null;
	
	// open the db
database.webdb.open = function() {
  var dbSize = 5 * 1024 * 1024; // 5MB
  console.log("Size is " + dbSize);
  try {
  	database.webdb.db = openDatabase('Comments', '1.0', 'saves comments', dbSize);
	console.log(database.webdb.db);
  } catch (e) {
    console.log(e);
  }
}	

	
	// handling error
database.webdb.onError = function(tx, e) {
  console.log('Something unexpected happened: ' + e.message );
}

// on success
database.webdb.onSuccess = function(tx, r) {
  // re-render all the data
  // loadTodoItems is defined in Step 4a
  //database.webdb.getAllTodoItems(loadTodoItems);
  log('DB opened successfully');
}

// gets a comment
database.webdb.getComment = function(renderFunc, id) {
  //console.log('Id in getcomment = ' + id);
  database.webdb.db.transaction(function(tx) {
  	console.log('Id passed in: ' + id);
    tx.executeSql('SELECT * FROM comment WHERE ID=?', [id.toString()], renderFunc, 
        	database.webdb.onError);
  });
}

// stores the last comment
var lastComment;

// callback function for checking if a comment exists in the table
function getCommentCB(tx, rs) {
	console.log('\nRS Length = ' + rs.rows.length);
  	
  	for (var i=0; i < rs.rows.length; i++) {
  		console.log('RS ' + i + ' = ' + rs.rows.item(i));
  	}
	if (rs.rows.length == 0) // none found
		lastComment = -1;
	else
  		lastComment = rs.rows.item(0).comment;
		
	console.log('lastComment: ' + lastComment);
  /*var todoItems = document.getElementById('todoItems');
  todoItems.innerHTML = rowOutput;*/
}
	
      var logging = false;
      var key = "id";
	  var val1;	
	
	  // start
	  function start() {
	  	populate();
		populate();
	  }
	
	  // populates the popup
      function populate() {
        //log('entered populate()');
		
		// open database
		try {
		database.webdb.open();
		console.log('database open');
		
        val1 = getValue(key);
		val1 = parseInt(val1) - 1;
		console.log('Val1 = ' + val1);
        updateValues(val1);
        //log('leaving populate()');
		} catch (e) {
	        console.log("error while doing something");
	        console.log(e);
	      }
      }
      
      function getValue(key) {
        return chrome.extension.getBackgroundPage().getItem(key);
      }

      function updateValues(value) {
	  	console.log('Inside update values');
	    // look up the database 
	    database.webdb.getComment(getCommentCB, value);
	  	setTimeout("console.log('After get comment')", 000);
	  
        setTimeout("document.getElementById('lastcomment').innerHTML = lastComment", 1000);
      }

    </script>
  </head>
  <body onload='start()'>
    <div id='lastcomment'><!--Last value will show up here-->
	</div>
	<!-- <form name='form1'>
      <table class="my_table" cellpadding="0" cellspacing="0" width=200px>
        <tr>
	  	  <td class="style1" colspan="2" align="center">Local Storage Sample</td>
	  	</tr>
	  	<tr class="odd">
		  <td class="rborder" >Please Enter the name</td>
		  <td class="ralign"><input type='text' size='6' name='fname'/></td>
		</tr>
		<tr class="even">
		  <td class="rborder" colspan="2" align='center'>
		    <input type='submit' value='store' OnClick='store()'/>
		    <input type='submit' value='clear' OnClick='clearStorage()'/></td>
	    </tr>
		<tr class="odd"
		  <td class="rborder"></td>
		  <td class="ralign"></td>
		</tr>
		<tr class="even">
		<td colspan="2"><a  href='javascript:void(0);' onclick='chrome.tabs.create({url: "comments.html"});'>Previous Values Stored</a></td>
		</tr>
		<tr class="odd"
		  <td class="rborder">Last Value stored 1</td>
		  <td class="ralign"><div id='val1'/></td>
		</tr>
		<tr class="even"
		  <td class="rborder">Last Value stored 2</td>
		  <td class="ralign"><div id='val2'/></td>
		</tr>
		<tr class="odd"
	      <td class="rborder">Last Value stored 3</td>
		  <td class="ralign"><div id='val3'/></td>
		</tr>
      </table>
    </form>-->
  </body>
</html>
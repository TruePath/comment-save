<html>
  <head>
  	<link rel="stylesheet" href="Style2.css" />
	
	<!-- Javascript -->
	<script type="text/javascript" src="jquery.js"></script>
    <script>
	// webdb stuff
	var database = {};
  	database.webdb = {};
	database.webdb.db = null;
	
	// open the db
	database.webdb.open = function() {
  		var dbSize = 5 * 1024 * 1024; // 5MB
  		console.log("Size is " + dbSize);
  		try {
  			database.webdb.db = openDatabase('Comments', '1.0', 'saves comments', dbSize);
			console.log(database.webdb.db);
  		} catch (e) {
    		console.log(e);
  		}
	}	

	// handling error
	database.webdb.onError = function(tx, e) {
  		console.log('Something unexpected happened: ' + e.message );
	}

	// on success
	database.webdb.onSuccess = function(tx, r) {
  		console.log('DB opened successfully');
	}

	// gets a comment
	database.webdb.getComment = function(renderFunc, id) {
		//console.log('Id in getcomment = ' + id);
		database.webdb.db.transaction(function(tx) {
			console.log('Id passed in: ' + id);
			tx.executeSql('SELECT * FROM comment WHERE ID=?', [id.toString()], renderFunc, 
				database.webdb.onError);
		});
	}

	// stores the last comment
	var lastComment;		
	var lastURL;
	var lastTitle;
	
	// callback function for checking if a comment exists in the table
	function getCommentCB(tx, rs) {
		console.log('\nRS Length = ' + rs.rows.length);
		
		for (var i=0; i < rs.rows.length; i++) {
			console.log('RS ' + i + ' = ' + rs.rows.item(i));
		}
		if (rs.rows.length == 0) {// none found
			lastComment = "No comments saved!";
			lastURL = "";
			lastTitle = "";
		}
		else {
			lastComment = rs.rows.item(0).comment;
			lastURL = rs.rows.item(0).url;
			lastTitle = rs.rows.item(0).title;
		}
			
		// hack:
		// if comment is only size 
		console.log('lastComment: ' + lastComment);
		console.log('lastTitle: ' + lastTitle);
		console.log('lastURL: ' + lastURL);
	}

	// Variables for getting the key from localstorage	
	var logging = false;
	var key = "id";
	var val1;	
	
	// start
	function start() {
		addAllItems();
	}
	
	// adds all the comments on the display page
	function addAllItems() {
		try {
			// open up the database
			database.webdb.open();
		
			// load all the items
			database.webdb.getAllComments(loadComments);
			
		} catch (e) {
	        console.log("error while doing something");
	        console.log(e);
	      }
	}
	
	// SQL query to get all the comments
	database.webdb.getAllComments = function(renderFunc) {
		database.webdb.db.transaction(function(tx) {
			tx.executeSql('SELECT * FROM comment', [], renderFunc, 
						database.webdb.onError);
  		});
	}
	
	// Loads all the comments
	function loadComments(tx, rs) {
		var rowOutput = "";
		for (var i=0; i < rs.rows.length; i++) {
			// render only if comment's length is greater than 1 [TODO]
			if (rs.rows.item(i).comment.length > 1)
				rowOutput += renderTodoTable(rs.rows.item(i));
		}
	}
	
	// attaches one row of the table to the list
	// {id: newId, comment: this.value, title: document.tile, url: document.URL, time: timestamp});
	function renderTodo(row) {
		var list = document.getElementById('List'); 
		var li = document.createElement("li");
		var text = '<input type = "checkbox" name = "' + row.ID + '">' + '<a href=' + row.url+ '>' + row.title + '</a>\t' + row.comment + '\t' + row.timestamp;
		li.innerHTML = text;
		list.appendChild(li);
  		//return '<li>' + row.ID + '[<a onclick="database.webdb.deleteTodo(' + row.ID + ');"'>X</a>]</li>';
	}
    
	// renders to the table	
	function renderTodoTable(row) {
		var table = document.getElementById('tablebody');
		
		// the row
		var tr = document.createElement("tr");
		
		// the elements
		var td1 = document.createElement("td");
		var td2 = document.createElement("td");
		var td3 = document.createElement("td");
		var td4 = document.createElement("td");
		
		// delete checkbox
		td1.innerHTML = '<input type = "checkbox" name = "'+ row.ID + '"/>';
		td1.width="10";
		// page
		td2.innerHTML = '<a href=' + row.url+ '>' + row.title + '</a>';
		td1.width="100";
		// comment
		td3.innerHTML = row.comment;
		td1.width="400";
		// date/time
		td4.innerHTML = row.timestamp;
		td1.width="10";
		
		// append to the row
		tr.appendChild(td1);
		tr.appendChild(td2);
		tr.appendChild(td3);
		tr.appendChild(td4);
		//console.log(tr);
		
		table.appendChild(tr);		
	}
	  
	// returns the item from local storage given the key	  
	function getValue(key) {
		return chrome.extension.getBackgroundPage().getItem(key);
	}
	
	// Redraws the list
	function redraw() {
		/*var list = document.getElementById('List'); 
		while (list.hasChildNodes()) {
    		list.removeChild(list.lastChild);
		}*/

		$("#tablebody tr").remove();
		
		// load all the items
		database.webdb.getAllComments(loadComments);
	}
	
	// selects/unselects all checkboxes [for deletion]
	function selectAll() {
		// is it checked or not?
		var isChecked = document.getElementById('selectAllCheckbox').checked;
		
		// get all checkboxes
		// get all the checked items first
		var inputs = document.getElementsByTagName('input');  
  		var len = inputs.length;
		console.log('Checkboxes: ' + len);
   		var i;  
   		for(i = 0; i < len; i++) {
			if (inputs[i].type == 'checkbox')
				inputs[i].checked = isChecked;
		}
	}
	
	// deletes the checked comments
	function deleteChecked() {
		// get all the checked items first
		var inputs = document.getElementsByTagName('input');  
  		var len = inputs.length;
		console.log('Checkboxes: ' + len);
   		var i;  
   		for(i = 0; i < len; i++) {
			if (inputs[i].type == 'checkbox')
				if (inputs[i].checked)			
					database.webdb.deleteComment(inputs[i].name);
		}
		
		// re-draw the whole list...
		redraw();
	}
	
	// deletes one row from the table given the id
	database.webdb.deleteComment = function(id) {
		database.webdb.db.transaction(function(tx) {
			tx.executeSql('DELETE FROM comment WHERE ID=?', [id],
				database.webdb.onSuccess, database.webdb.onError);
		});
	}
	
	// deletes all the comments 
	function deleteAll() {
		// ask for confirmation
		var answer = confirm ("Are you sure? Click OK to confirm or CANCEL")
		if (answer){
		}
		else
			return;
	
		// reset id in local storage
		chrome.extension.getBackgroundPage().clearStrg();

		// delete all the comments
		database.webdb.db.transaction(function(tx) {
			tx.executeSql('DELETE FROM comment');
		});
		
		// redraw
		redraw();
	}

    </script>
  </head>
  <body onload='start()'>
    <div id='holder'>
		<div id='Title'>					<!-- Page Title -->
		Comment Save Extension- Viewing all comments
		</div>
		<div id='Buttons'>					<!-- Delete buttons -->
			<input type="button" class="delete" value="Delete Checked Comments" onClick="deleteChecked();">
			<input type="button" class="delete" value="Delete All Comments" onClick="deleteAll();">
		</div>
		
		<!--<ul id='List'>
		</ul> 
		<table id="theTable">
			<tr align="center">
				<th width="10">Delete?</th>
				<th width="300">Page</th>
				<th width="600">The Comment</th>
				<th width="80">Date & Time</th>
			</tr>
		</table> -->
		
		<!-- xhtml table -->
		<table id="hor-minimalist-b" summary="Table1">
    		<thead>
    			<tr>
        		<th scope="col" width="3%">Delete?<br><input type = "checkbox" id="selectAllCheckbox" onClick="selectAll();"/></th>
            	<th scope="col" width="22%">Page</th>
            	<th scope="col" width="60%">The Comment</th>
            	<th scope="col" width="15%">Date & Time</th>
        		</tr>
    		</thead>
    		<tbody id="tablebody">
    		
    		</tbody>
		</table>
	</div>
	
  </body>
</html>
<html>
  <head>
  	<link rel="stylesheet" href="Style2.css" />
	
	<!-- Javascript -->
	<script type="text/javascript" src="jquery.js"></script>
    <script>
	
	// debugging
	var logging = true;
	
	
	// webdb stuff
	var database = {};
  	database.webdb = {};
	database.webdb.db = null;
	
	// open the db
	database.webdb.open = function() {
  		var dbSize = 5 * 1024 * 1024; // 5MB
  		log("Size is " + dbSize);
  		try {
  			database.webdb.db = openDatabase('Comments', '1.0', 'saves comments', dbSize);
			log(database.webdb.db);
  		} catch (e) {
    		log(e);
  		}
	}	

	// handling error
	database.webdb.onError = function(tx, e) {
  		log('Something unexpected happened: ' + e.message );
	}

	// on success
	database.webdb.onSuccess = function(tx, r) {
  		log('DB opened successfully');
	}

	// gets a comment
	database.webdb.getComment = function(renderFunc, id) {
		//log('Id in getcomment = ' + id);
		database.webdb.db.transaction(function(tx) {
			log('Id passed in: ' + id);
			tx.executeSql('SELECT * FROM comment WHERE ID=?', [id.toString()], renderFunc, 
				database.webdb.onError);
		});
	}

	// start
	function start() {
		// all the comments
		addAllComments();
		
		// all the filters
		redrawFilters();
		
	}
	
	// adds all the comments on the display page
	function addAllComments() {
		try {
			// open up the database
			database.webdb.open();
		
			// load all the items
			database.webdb.getAllComments(loadComments);
			
		} catch (e) {
	        log("error while doing something");
	        log(e);
	      }
	}
	
	// SQL query to get all the comments
	database.webdb.getAllComments = function(renderFunc) {
		database.webdb.db.transaction(function(tx) {
			tx.executeSql('SELECT * FROM comment', [], renderFunc, 
						database.webdb.onError);
  		});
	}
	
	// Loads all the comments
	function loadComments(tx, rs) {
		var rowOutput = "";
		// last one at the top
		for (var i=rs.rows.length - 1; i >= 0; i--) {
			// render only if comment's length is greater than 1 [TODO]
			if (rs.rows.item(i).comment.length > 1)
				rowOutput += renderTodoTable(rs.rows.item(i));
		}
	}
    
	// renders to the table	
	function renderTodoTable(row) {
		var table = document.getElementById('tablebody');
		
		// the row
		var tr = document.createElement("tr");
		
		// the elements
		var td1 = document.createElement("td");
		var td2 = document.createElement("td");
		var td3 = document.createElement("td");
		var td4 = document.createElement("td");
		
		// delete checkbox
		td1.innerHTML = '<input type = "checkbox" name = "'+ row.ID + '"/>';
		td1.width="10";
		// page
		td2.innerHTML = '<span style="word-break:break-all;"><a href=' + row.url+ '>' + row.title + '</a></span>';
		td1.width="100";
		// comment
		td3.innerText= row.comment;
		td1.width="400";
		// date/time
		td4.innerText = row.timestamp;
		td1.width="10";
		
		// append to the row
		tr.appendChild(td1);
		tr.appendChild(td2);
		tr.appendChild(td3);
		tr.appendChild(td4);
		//log(tr);
		
		table.appendChild(tr);		
	}
	
	// Redraws the list
	function redraw() {
		$("#tablebody tr").remove();
		
		// load all the items
		database.webdb.getAllComments(loadComments);
	}
	
	// selects/unselects all checkboxes [for deletion]
	function selectAll() {
		// is it checked or not?
		var isChecked = document.getElementById('selectAllCheckbox').checked;
		
		// get all checkboxes
		// get all the checked items first
		var inputs = document.getElementsByTagName('input');  
  		var len = inputs.length;
		log('Checkboxes: ' + len);
   		var i;  
   		for(i = 0; i < len; i++) {
			if (inputs[i].type == 'checkbox')
				inputs[i].checked = isChecked;
		}
	}
	
	// deletes the checked comments
	function deleteChecked() {
		// get all the checked items first
		var inputs = document.getElementsByTagName('input');  
  		var len = inputs.length;
		log('Checkboxes: ' + len);
   		var i;  
   		for(i = 0; i < len; i++) {
			if (inputs[i].type == 'checkbox')
				if (inputs[i].checked)			
					database.webdb.deleteComment(inputs[i].name);
		}
		
		// re-draw the whole list...
		redraw();
	}
	
	// deletes one row from the table given the id
	database.webdb.deleteComment = function(id) {
		database.webdb.db.transaction(function(tx) {
			tx.executeSql('DELETE FROM comment WHERE ID=?', [id],
				database.webdb.onSuccess, database.webdb.onError);
		});
	}
	
	// deletes all the comments 
	function deleteAll() {
		// ask for confirmation
		var answer = confirm ("Are you sure? Click OK to confirm or CANCEL")
		if (answer){
		}
		else
			return;
	
		// reset id in local storage
		chrome.extension.getBackgroundPage().clearStrg();

		// delete all the comments
		database.webdb.db.transaction(function(tx) {
			tx.executeSql('DELETE FROM comment');
		});
		
		// redraw
		redraw();
	}

	// log function
	function log(txt) {
		if(logging) {
			console.log(txt);
		}
	}
	
	/****************************************************
	
			FOR FILTERS
	
	****************************************************/
	
	// adds filters provided by the user
	function addFilters() {
		var textbox = document.getElementById("newFilters");//.value;
		
		// split it up
		var text = textbox.value;
		var lines = text.split("\n");
		var length = lines.length;
		
		// add each filter individually
		for (var i = 0; i < length; i++) {
			if (lines[i] != "") {
				log("Adding: " + lines[i]);
				database.webdb.addFilter(lines[i]);
			}
		}
	
		// reset the textarea
		textbox.value = "";
		// redraw all the filters
		redrawFilters();
	}
	
	// adds a filter to the table - gets a url from the textarea
	database.webdb.addFilter = function(filter) {
		// SQL transaction
		database.webdb.db.transaction(function(tx){
			tx.executeSql('INSERT INTO filters(website) VALUES (?)', 
			[filter],
			database.webdb.onSuccess,
			database.webdb.onError);
		});
	}	
	
	// SQL query to get all the filters
	database.webdb.getAllFilters = function(renderFunc) {
		database.webdb.db.transaction(function(tx) {
			tx.executeSql('SELECT * FROM filters', [], renderFunc, 
						database.webdb.onError);
  		});
	}
	
	// Loads all the filters
	function loadFilters(tx, rs) {
		var rowOutput = "";
		for (var i=0; i < rs.rows.length; i++) {
			rowOutput += renderFilterTable(rs.rows.item(i));
		}
	}
    
	// renders each filter to the selection box
	function renderFilterTable(row) {
		var select = document.getElementById('viewFilters');
		
		// the elements
		var op = document.createElement("option");
		op.id = row.ID;
		
		// Filter - website
		op.innerText= row.website;

		// append to the selection box
		select.appendChild(op);
		//log(tr);		
	}
	
	// Redraws the list
	function redrawFilters() {
		$("#viewFilters option").remove();
		
		// load all the items
		database.webdb.getAllFilters(loadFilters);
		
		// add the extra one
		//addExtra();
	}
	
	function addExtra() {
		var select = document.getElementById('viewFilters');
		var op = document.createElement("option");
		op.innerHTML= '<option disabled="true">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</option>';
		select.appendChild(op);
	}
	
	// delete selected filters
	function deleteSelectedFilters() {
		var myselect=document.getElementById("viewFilters");
		var l = myselect.options.length;
		for (var i=0; i<l; i++){
			if (myselect.options[i].selected){
				// delete the filter
				database.webdb.deleteFilter(myselect.options[i].id);
			
				// delete this one
				myselect.options[i] = null;
			}	
		}
	}
	
	// deletes one row from the table given the id
	database.webdb.deleteFilter = function(id) {
		database.webdb.db.transaction(function(tx) {
			tx.executeSql('DELETE FROM filters WHERE ID=?', [id],
				database.webdb.onSuccess, database.webdb.onError);
		});
	}
	
	// deletes all the filters 
	function deleteAllFilters() {
		// ask for confirmation
		var answer = confirm ("Are you sure? Click OK to confirm or CANCEL")
		if (answer){
		}
		else
			return;
		
		// delete everything from the filters table
		database.webdb.db.transaction(function(tx) {
			tx.executeSql('DELETE FROM filters');
		});
		
		// redraw filters
		redrawFilters();
		
		/*var myselect=document.getElementById("sample")
		for (var i=0; i<myselect.options.length; i++){
			if (myselect.options[i].selected==true){
				alert("Selected Option's index: "+i);
				break;
			}	
		}*/
	}
	
	
	
    </script>
  </head>
  <body onload='start()'>
    <div id='holder'>
		<div id='Title'>					<!-- Page Title -->
			Comment Save - Viewing all filters and comments
		</div>
		<br><br>
		<hr>
		<div id='Filters'>					<!-- Filter information -->
			<div id='AddFilters'>			<!-- Left-side: For adding filters -->
				Filters allow you to disable tracking on websites.<br>
				Enter filters into the box below (one per line). For example, if you don't want your comments on
				Facebook tracked enter "facebook.com" (without the quotes).<br><br>
				<textarea cols="50" rows="6" id="newFilters"></textarea><br><br>
				<input type="button" class="filterbuttons" value="Add New Filters" onClick="addFilters();">
			</div>
			
			<div id='DeleteFilters'>        <!-- Right-side: Viewing/deleting filters -->
				<b><div id="fText">Filters:</span></b></div>
				<select size="10" id="viewFilters" multiple="true">
				</select>
				<br><br>
				<input type="button" class="filterbuttons" value="Delete Selected Filters" onClick="deleteSelectedFilters();">&nbsp;&nbsp;
				<input type="button" class="filterbuttons" value="Delete All Filters" onClick="deleteAllFilters();">
			</div>
			<!-- <a href="filters.html">View/Edit Filters</a> -->
		</div>
		<br><br><br>
		<hr>
		<div id='Buttons'>					<!-- Delete buttons -->
			<input type="button" class="delete" value="Delete Checked Comments" onClick="deleteChecked();">
			<input type="button" class="delete" value="Delete All Comments" onClick="deleteAll();">
		</div>
		<!-- xhtml table -->
		<table id="hor-minimalist-b" summary="Table1">
    		<thead>
    			<tr>
        		<th scope="col" width="3%">Delete?<br><input type = "checkbox" id="selectAllCheckbox" onClick="selectAll();"/></th>
            	<th scope="col" width="30%">Page</th>
            	<th scope="col" width="47%">The Comment</th>
            	<th scope="col" width="20%">Date & Time</th>
        		</tr>
    		</thead>
    		<tbody id="tablebody">
    		
    		</tbody>
		</table>
		<div class="push">Comment Save. Copyright Shayan Javed 2010-11<sup>&copy;</sup>. </div>
	</div>
	<div class="footer"></div>
  </body>
</html>
<html>
  <head>
  	<link rel="stylesheet" href="Style2.css" />
	
	<!-- Javascript -->
	<script type="text/javascript" src="jquery.js"></script>
    <script>
	// webdb stuff
	var database = {};
  	database.webdb = {};
	database.webdb.db = null;
	
	// open the db
	database.webdb.open = function() {
  		var dbSize = 5 * 1024 * 1024; // 5MB
  		console.log("Size is " + dbSize);
  		try {
  			database.webdb.db = openDatabase('Comments', '1.0', 'saves comments', dbSize);
			console.log(database.webdb.db);
  		} catch (e) {
    		console.log(e);
  		}
	}	

	// handling error
	database.webdb.onError = function(tx, e) {
  		console.log('Something unexpected happened: ' + e.message );
	}

	// on success
	database.webdb.onSuccess = function(tx, r) {
  		console.log('DB opened successfully');
	}

	// gets a comment
	database.webdb.getComment = function(renderFunc, id) {
		//console.log('Id in getcomment = ' + id);
		database.webdb.db.transaction(function(tx) {
			console.log('Id passed in: ' + id);
			tx.executeSql('SELECT * FROM filters WHERE ID=?', [id.toString()], renderFunc, 
				database.webdb.onError);
		});
	}	
	
	// start
	function start() {
		addAllItems();
	}
	
	// adds all the comments on the display page
	function addAllItems() {
		try {
			// open up the database
			database.webdb.open();
		
			// load all the items
			database.webdb.getAllComments(loadComments);
			
		} catch (e) {
	        console.log("error while doing something");
	        console.log(e);
	      }
	}
	
	// SQL query to get all the comments
	database.webdb.getAllComments = function(renderFunc) {
		database.webdb.db.transaction(function(tx) {
			tx.executeSql('SELECT * FROM filters', [], renderFunc, 
						database.webdb.onError);
  		});
	}
	
	// Loads all the comments
	function loadComments(tx, rs) {
		var rowOutput = "";
		for (var i=0; i < rs.rows.length; i++) {
			rowOutput += renderTodoTable(rs.rows.item(i));
		}
	}
    
	// renders to the table	
	function renderTodoTable(row) {
		var table = document.getElementById('tablebody');
		
		// the row
		var tr = document.createElement("tr");
		
		// the elements
		var td1 = document.createElement("td");
		var td2 = document.createElement("td");
		var td3 = document.createElement("td");
		
		// delete checkbox
		td1.innerHTML = '<input type = "checkbox" name = "'+ row.ID + '"/>';
		// Name
		td2.innerHTML = '<span style="word-break:break-all;">' + row.name + '</span>';
		// Filter - website
		td3.innerText= row.website;

		// append to the row
		tr.appendChild(td1);
		tr.appendChild(td2);
		tr.appendChild(td3);
		//console.log(tr);
		
		table.appendChild(tr);		
	}
	  
	// returns the item from local storage given the key	  
	function getValue(key) {
		return chrome.extension.getBackgroundPage().getItem(key);
	}
	
	// Redraws the list
	function redraw() {
		$("#tablebody tr").remove();
		
		// load all the items
		database.webdb.getAllComments(loadComments);
	}
	
	// selects/unselects all checkboxes [for deletion]
	function selectAll() {
		// is it checked or not?
		var isChecked = document.getElementById('selectAllCheckbox').checked;
		
		// get all checkboxes
		// get all the checked items first
		var inputs = document.getElementsByTagName('input');  
  		var len = inputs.length;
		console.log('Checkboxes: ' + len);
   		var i;  
   		for(i = 0; i < len; i++) {
			if (inputs[i].type == 'checkbox')
				inputs[i].checked = isChecked;
		}
	}
	
	// deletes the checked comments
	function deleteChecked() {
		// get all the checked items first
		var inputs = document.getElementsByTagName('input');  
  		var len = inputs.length;
		console.log('Checkboxes: ' + len);
   		var i;  
   		for(i = 0; i < len; i++) {
			if (inputs[i].type == 'checkbox')
				if (inputs[i].checked)			
					database.webdb.deleteComment(inputs[i].name);
		}
		
		// re-draw the whole list...
		redraw();
	}
	
	// deletes one row from the table given the id
	database.webdb.deleteComment = function(id) {
		database.webdb.db.transaction(function(tx) {
			tx.executeSql('DELETE FROM filters WHERE ID=?', [id],
				database.webdb.onSuccess, database.webdb.onError);
		});
	}
	
	// deletes all the comments 
	function deleteAll() {
		// ask for confirmation
		var answer = confirm ("Are you sure? Click OK to confirm or CANCEL")
		if (answer){
		}
		else
			return;
	
		// reset id in local storage
		chrome.extension.getBackgroundPage().clearStrg();

		// delete all the comments
		database.webdb.db.transaction(function(tx) {
			tx.executeSql('DELETE FROM filters');
		});
		
		// redraw
		redraw();
	}

    </script>
  </head>
  <body onload='start()'>
    <div id='holder'>
		<div id='Title'>					<!-- Page Title -->
		Comment Save Extension - Filters
		</div>
		<div id='Buttons'>					<!-- Delete buttons -->
			<input type="button" class="delete" value="Delete Checked Filters" onClick="deleteChecked();">
			<input type="button" class="delete" value="Delete All Filters" onClick="deleteAll();">
		</div>
		<!-- xhtml table -->
		<table id="hor-minimalist-b" summary="Table1">
    		<thead>
    			<tr>
        		<th scope="col" width="3%">Delete?<br><input type = "checkbox" id="selectAllCheckbox" onClick="selectAll();"/></th>
            	<th scope="col" width="22%">Name</th>
            	<th scope="col" width="70%">Website</th>
        		</tr>
    		</thead>
    		<tbody id="tablebody">
    		
    		</tbody>
		</table>
		<div class="push"></div>
	</div>
	<div class="footer"></div>
  </body>
</html>